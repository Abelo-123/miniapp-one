import{r as i,j as s}from"./react-vendor-C-oIHjE7.js";import{u as D,f as j,i as d,j as E,h as C}from"./index-G9JVDcjH.js";import{L as T,b as y,I as _,B as v,P as k}from"./tma-ui-zNZ4TOi0.js";import"./tma-sdk-CX7cczhn.js";const A=[100,500,1e3,2e3];function I(){const{user:n,deposits:h,setBalance:m,showToast:o,refreshDeposits:u}=D(),[c,l]=i.useState(""),[g,x]=i.useState(!1),[f,p]=i.useState("");i.useEffect(()=>{(async()=>{const t=new URLSearchParams(window.location.search),a=t.get("ref"),r=t.get("amount");a&&r&&t.get("deposit_complete")==="1"&&(window.history.replaceState({},"",window.location.pathname),await N(parseFloat(r),a))})()},[]);const N=i.useCallback(async(e,t)=>{try{const r=await(await fetch("http://localhost/paxyo/deposit_handler.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:e,reference_id:t})})).json();if(r.status==="success")o("success",`Deposited ${j(e)} successfully!`),d("success"),m(parseFloat(r.new_balance)),u(),l("");else throw new Error(r.message)}catch(a){o("error",a.message||"Error verifying deposit"),d("error")}},[o,m,u]),w=i.useCallback(async e=>{if(!e||e<10){o("error","Minimum deposit is 10 ETB"),d("error");return}x(!0),p("");try{const a=await(await fetch("http://localhost/paxyo/chapa_init.php",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({amount:e,user_id:n?.id||111,user_name:n?.first_name||"User"})})).json();a.checkout_url?E(a.checkout_url):p(a.error||"Failed to create payment session")}catch(t){console.error("Chapa error:",t),p("Payment initialization failed")}x(!1)},[n,o]),S=()=>{const e=parseInt(c);if(!e||e<10){o("error","Minimum deposit is 10 ETB"),d("error");return}w(e)},b=e=>{C();const t=parseInt(c)||0;l(String(t+e))};return s.jsxs(T,{children:[s.jsx(y,{children:s.jsx("div",{style:{padding:"16px"},children:s.jsxs("div",{className:"dp-balance",children:[s.jsx("span",{style:{color:"var(--tg-theme-hint-color)",fontSize:"13px"},children:"Current Balance"}),s.jsx("div",{style:{fontSize:"24px",fontWeight:"bold"},children:n?j(n.balance):"Loading..."})]})})}),s.jsxs(y,{header:"Add Funds",children:[s.jsx(_,{header:"Amount",placeholder:"Enter amount (min 10)",type:"number",value:c,onChange:e=>l(e.target.value)}),s.jsx("div",{style:{padding:"12px 16px",display:"flex",gap:8,overflowX:"auto"},children:A.map(e=>s.jsxs(v,{size:"s",mode:"bezeled",onClick:()=>b(e),children:["+",e]},e))}),f&&s.jsx("div",{style:{padding:"12px 16px",color:"var(--tg-theme-destructive-text-color, #ff4757)"},children:f}),s.jsx("div",{style:{padding:"16px"},children:s.jsx(v,{size:"l",stretched:!0,onClick:S,loading:g,disabled:!c||parseInt(c)<10,children:"Deposit via Chapa"})})]}),s.jsxs("div",{className:"dp-table-container",children:[s.jsxs("div",{className:"dp-table-header",children:[s.jsx("div",{className:"dp-col dp-col-id",children:"ORDER ID"}),s.jsx("div",{className:"dp-col dp-col-amount",children:"AMOUNT"}),s.jsx("div",{className:"dp-col dp-col-ref",children:"TRANSACTION"}),s.jsx("div",{className:"dp-col dp-col-date",children:"DATE"})]}),h.length===0?s.jsx(k,{description:"No deposits yet"}):h.map(e=>s.jsxs("div",{className:"dp-table-row",children:[s.jsxs("div",{className:"dp-col dp-col-id",children:["#",e.id]}),s.jsx("div",{className:"dp-col dp-col-amount",children:e.amount}),s.jsx("div",{className:"dp-col dp-col-ref",children:e.reference_id}),s.jsx("div",{className:"dp-col dp-col-date",children:new Date(e.created_at).toLocaleDateString(void 0,{month:"numeric",day:"numeric",year:"2-digit"})})]},e.id))]})]})}export{I as DepositPage};
