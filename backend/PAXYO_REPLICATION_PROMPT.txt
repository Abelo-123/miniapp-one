# PAXYO SMM — Complete App Replication Prompt

This document provides an exhaustive, line-by-line blueprint of every functionality in the Paxyo SMM application. Another AI coding agent should be able to read this file alone and rebuild an **exact functional replica** of the app (UI design may differ). Every API endpoint, database table, frontend flow, authentication mechanism, real-time system, and integration is described below.

---

## 1. PROJECT OVERVIEW

**Paxyo** is a Social Media Marketing (SMM) panel that runs as:
- A **Telegram Mini App** (primary platform — launched inside Telegram via a bot).
- A **standalone web app** (accessible via browser with Google OAuth login).

### Core Features
1. **Browse & order** social media services (followers, likes, views, comments, etc.) from an external SMM provider.
2. **Deposit funds** via Chapa (Ethiopian Birr / ETB payment gateway).
3. **Track order history** with real-time status updates via Server-Sent Events (SSE).
4. **Live support chat** with admin (also real-time via SSE).
5. **Admin notifications** sent to a separate bot backend on every significant event.
6. **Holiday discounts** system for promotional pricing.
7. **Maintenance mode** with per-user override.
8. **Recommended/Top services** curated by admin.

---

## 2. TECHNOLOGY STACK

| Layer | Technology |
|---|---|
| Backend | PHP 7.4+ (procedural/functional style, no framework) |
| Database | MySQL (via `mysqli`) |
| Frontend | Single HTML page (SPA-style), Vanilla JavaScript ES6+, Tailwind CSS (CDN), Vanilla CSS |
| SMM Provider | GodOfPanel API v2 (`https://godofpanel.com/api/v2`) |
| Payment | Chapa Inline Checkout SDK (`https://js.chapa.co/v1/inline.js`) |
| Telegram SDK | `telegram-web-app.js` (v7.10+) |
| Auth | Telegram `initData` HMAC-SHA256 validation + Google OAuth 2.0 |
| Real-time | Server-Sent Events (SSE) — two streams: main updates + chat |
| Admin Alerts | HTTP POST to a Node.js bot backend (`notify_bot_admin`) |

---

## 3. FILE STRUCTURE

```
/
├── index.php                  # Entry router — detects Telegram/web, routes to smm.php or login.php
├── smm.php                    # Main app (HTML + CSS + JS — all-in-one SPA)
├── login.php                  # Web login page (Google Sign-In button)
├── db.php                     # Database connection + helper functions (db, db_select, db_insert, etc.)
├── config_telegram.php        # TELEGRAM_BOT_TOKEN, BOT_API_URL constants
├── config_google.php          # GOOGLE_CLIENT_ID, SECRET, REDIRECT_URI, endpoints
├── utils_bot.php              # notify_bot_admin() function — sends JSON to bot
│
├── telegram_auth.php          # POST — validates Telegram initData, creates/updates user
├── google_auth.php            # Google OAuth callback handler — creates/updates user
│
├── get_service.php            # GET — fetches SMM services (cached, with rate conversion)
├── get_recommended.php        # GET — returns admin-curated recommended service IDs
├── process_order.php          # POST — places an order with external API
├── get_orders.php             # GET — returns user's order history
├── check_order_status.php     # GET — syncs order statuses with external API
├── order_manager.php          # syncOrderStatuses() function (refund logic included)
├── user_actions.php           # POST — handles refill requests
│
├── deposit_handler.php        # POST — records deposit, updates balance
├── get_deposits.php           # GET — returns user's recent deposits
│
├── get_alerts.php             # GET — returns user alerts + unread count
├── mark_alerts_read.php       # GET — marks all user alerts as read
│
├── chat_api.php               # POST/GET — send/fetch chat messages
├── chat_stream.php            # SSE — real-time chat message stream
├── realtime_stream.php        # SSE — unified real-time stream (orders, alerts, balance, maintenance)
├── heartbeat.php              # GET — updates user's last_seen timestamp
│
├── webhook_handler.php        # POST — receives order status webhooks from SMM provider
├── cron_check_orders.php      # CLI — periodic cron job to sync order statuses
│
├── cache/
│   └── services.json          # Cached services data from external API
├── chat_data/
│   └── chat_{userId}.json     # Per-user chat message files
├── temp/
│   ├── paxyo_cron_active.flag # Flag file: exists when there are active orders
│   └── paxyo_state_{uid}.json # Per-user SSE state tracking files
│
└── admin/                     # Admin panel (separate — not part of user-facing replication)
    ├── index.php
    ├── api_*.php
    └── ...
```

---

## 4. DATABASE SCHEMA

### Table: `auth` (Users)
| Column | Type | Description |
|---|---|---|
| `tg_id` | BIGINT (PK) | Telegram user ID. For Google users: negative CRC32 hash of Google ID |
| `google_id` | VARCHAR | Google account ID (nullable) |
| `email` | VARCHAR | User email (nullable, from Google) |
| `first_name` | VARCHAR | Display name |
| `last_name` | VARCHAR | Last name (nullable) |
| `photo_url` | TEXT | Profile photo URL |
| `balance` | DECIMAL(10,2) | Current balance in ETB |
| `is_blocked` | TINYINT | 1 = blocked, 0 = active |
| `auth_provider` | VARCHAR | 'telegram' or 'google' |
| `last_login` | DATETIME | Last authentication time |
| `last_seen` | DATETIME | Last heartbeat timestamp |
| `created_at` | DATETIME | Account creation time |

### Table: `orders`
| Column | Type | Description |
|---|---|---|
| `id` | INT (PK, AUTO_INCREMENT) | Local order ID |
| `user_id` | BIGINT | FK → auth.tg_id |
| `api_order_id` | INT | Order ID from external SMM provider |
| `service_id` | INT | Service ID from provider |
| `service_name` | VARCHAR | Name of the service |
| `link` | TEXT | URL/link provided by user |
| `quantity` | INT | Number of items ordered |
| `charge` | DECIMAL(10,2) | Amount deducted from balance |
| `status` | VARCHAR | 'pending', 'processing', 'in_progress', 'completed', 'cancelled', 'partial' |
| `remains` | INT | Remaining items to deliver |
| `start_count` | INT | Initial count before order started |
| `created_at` | DATETIME | Order placement time |
| `updated_at` | DATETIME | Last status update time |

### Table: `deposits`
| Column | Type | Description |
|---|---|---|
| `id` | INT (PK, AUTO_INCREMENT) | |
| `user_id` | BIGINT | FK → auth.tg_id |
| `amount` | DECIMAL(10,2) | Deposit amount in ETB |
| `reference_id` | VARCHAR | Chapa transaction reference |
| `status` | VARCHAR | 'completed', 'pending', 'failed' |
| `created_at` | DATETIME | |

### Table: `settings`
| Column | Type | Description |
|---|---|---|
| `setting_key` | VARCHAR (PK) | Key name |
| `setting_value` | TEXT | Value |

**Known keys**: `rate_multiplier` (e.g., "55.0"), `maintenance_mode` ("0" or "1"), `maintenance_allowed_ids` (comma-separated user IDs allowed to order during maintenance), `marquee_text`.

### Table: `holidays`
| Column | Type | Description |
|---|---|---|
| `id` | INT (PK) | |
| `name` | VARCHAR | Holiday name (e.g., "Christmas Sale") |
| `discount_percent` | INT | Percentage discount (e.g., 10) |
| `status` | VARCHAR | 'active' or 'inactive' |
| `start_date` | DATE | |
| `end_date` | DATE | |

### Table: `service_adjustments`
| Column | Type | Description |
|---|---|---|
| `service_id` | INT (PK) | Service ID from external provider |
| `average_time` | VARCHAR | Human-readable delivery time (e.g., "2-4 Hours") |

### Table: `user_alerts`
| Column | Type | Description |
|---|---|---|
| `id` | INT (PK, AUTO_INCREMENT) | |
| `user_id` | BIGINT | FK → auth.tg_id |
| `message` | TEXT | Alert message content |
| `is_read` | TINYINT | 0 = unread, 1 = read |
| `created_at` | DATETIME | |

### Table: `chat_messages`
| Column | Type | Description |
|---|---|---|
| `id` | INT (PK, AUTO_INCREMENT) | |
| `user_id` | BIGINT | FK → auth.tg_id |
| `sender` | VARCHAR | 'user' or 'admin' |
| `message` | TEXT | Message content |
| `created_at` | DATETIME | |

### Table: `admin_recommended_services`
| Column | Type | Description |
|---|---|---|
| `service_id` | INT (PK) | Service ID from external provider |

### Table: `hidden_services` (referenced in frontend JS)
Used to hide specific service IDs from the user-facing service list.

---

## 5. AUTHENTICATION SYSTEM

### 5A. Telegram Mini App Auth (`telegram_auth.php`)
- **Method**: POST with JSON body `{ "initData": "<telegram_initData_string>" }`
- **Validation**: 
  1. Parse `initData` (URL-encoded key-value pairs).
  2. Extract `hash` parameter. Remove it from the data.
  3. Sort remaining params alphabetically.
  4. Create `data_check_string` by joining sorted params with `\n`.
  5. Compute `secret_key = HMAC-SHA256("WebAppData", TELEGRAM_BOT_TOKEN)`.
  6. Compute `computed_hash = HMAC-SHA256(data_check_string, secret_key)`.
  7. Compare `computed_hash` with `hash` (hex comparison).
  8. Check `auth_date` is within `TELEGRAM_INIT_DATA_EXPIRY` (86400 seconds).
- **User Creation**: If user doesn't exist in `auth` table, insert with `auth_provider = 'telegram'`. If exists, update `first_name`, `photo_url`, `last_login`, `last_seen`.
- **Session**: Sets `$_SESSION['tg_id']`, `$_SESSION['tg_first_name']`, `$_SESSION['tg_photo_url']`.
- **Response**: `{ "success": true, "user": { "id", "first_name", "display_name", "photo_url", "balance", "username" } }`.
- **Admin notification**: Sends `type: "newuser"` for new users.
- **Welcome alert**: Creates a `user_alerts` record for new users.

### 5B. Google OAuth (`google_auth.php`)
- **Flow**: Standard OAuth 2.0 Authorization Code flow.
  1. `?action=login` → Redirect to Google consent screen.
  2. Google redirects back with `?code=...&state=...`.
  3. Verify CSRF `state` token.
  4. Exchange `code` for `access_token` via Google Token endpoint.
  5. Fetch user info (id, email, name, picture) from Google UserInfo endpoint.
  6. Create/update user in `auth` table. Google users get **negative** IDs (via `-(abs(crc32(googleId)) % 1e9 + 1e9)`) to avoid collision with positive Telegram IDs.
  7. Set session and cookie. Redirect to `index.php`.

### 5C. Session Configuration (All Endpoints)
Every PHP file that needs auth must:
```php
session_set_cookie_params(['samesite' => 'None', 'secure' => true]);
if (session_status() === PHP_SESSION_NONE) session_start();
$user_id = $_SESSION['tg_id'] ?? $_COOKIE['id'] ?? null;
```

### 5D. Entry Router (`index.php`)
- Detects Telegram via User-Agent, Referer, or `tgWebApp*` GET params.
- If Telegram detected → include `smm.php` directly (JS handles auth via `telegram_auth.php`).
- If authenticated web user (session/cookie exists) → include `smm.php`.
- If unauthenticated → include `smm.php` (guest mode with limited functionality) OR redirect to `login.php`.

---

## 6. BACKEND API ENDPOINTS — DETAILED

### 6A. `get_service.php` — Fetch Services
- **Method**: GET
- **Query params**: `?refresh=1` (optional, forces cache refresh)
- **External API**: `https://godofpanel.com/api/v2?key={API_KEY}&action=services`
- **Caching Strategy** (Stale-While-Revalidate):
  1. If `cache/services.json` exists and is < 5 minutes old → serve from cache.
  2. If stale but exists → serve stale data immediately, then trigger background refresh.
  3. If `?refresh=1` → fetch fresh from API, save to cache.
  4. ETag support for HTTP-level caching.
- **Data Processing**:
  1. Fetch raw services array from API (each item has: `service`, `name`, `type`, `rate`, `min`, `max`, `category`, `refill`, `cancel`).
  2. Merge with `service_adjustments` table to add `average_time` field.
  3. Fetch `rate_multiplier` from `settings` table (e.g., 55.0 to convert USD to ETB).
  4. Multiply each service's `rate` by `rate_multiplier`.
  5. Return JSON array of processed services.
- **Response**: `[ { "service": 123, "name": "...", "type": "Default", "rate": "5.50", "min": 100, "max": 10000, "category": "Instagram Followers", "refill": true, "cancel": false, "average_time": "2-4 Hours" }, ... ]`

### 6B. `get_recommended.php` — Recommended Service IDs
- **Method**: GET
- **Logic**: Simple query to `admin_recommended_services` table.
- **Response**: `[123, 456, 789]` (array of service IDs)

### 6C. `process_order.php` — Place Order
- **Method**: POST (JSON body)
- **Input**: `{ "service": 123, "link": "https://...", "quantity": 1000, "comments": "..." (optional), "answer_number": 3 (optional for Poll type) }`
- **Logic**:
  1. Auth check — get `user_id` from session.
  2. Validate inputs: service ID exists in cache, link is not empty, quantity is between min/max, quantity is multiple of 10.
  3. Fetch service data from cache file (`cache/services.json`).
  4. Get `rate_multiplier` from `settings`.
  5. Get active holiday discount from `holidays` table (where `status = 'active'` and current date is between `start_date` and `end_date`).
  6. **Calculate charge**: `(quantity / 1000) * service_rate * rate_multiplier * (1 - discount/100)`.
  7. Check if user's balance >= charge.
  8. Check maintenance mode — if enabled, only `maintenance_allowed_ids` can proceed.
  9. **Call external API**: POST to `https://godofpanel.com/api/v2` with `{ key, action: "add", service, link, quantity, comments? }`.
  10. If API returns `{ "order": 12345 }` → success.
  11. Deduct balance: `UPDATE auth SET balance = balance - {charge} WHERE tg_id = {user_id}`.
  12. Insert order: `INSERT INTO orders (user_id, api_order_id, service_id, service_name, link, quantity, charge, status, created_at) VALUES (...)`.
  13. Create/touch `temp/paxyo_cron_active.flag` to activate cron job.
  14. Notify admin via `notify_bot_admin()`.
- **Response**: `{ "success": true, "order_id": 12345, "new_balance": 234.56 }` or `{ "error": "..." }`

### 6D. `get_orders.php` — Order History
- **Method**: GET
- **Logic**:
  1. Auth check.
  2. Early session lock release (`session_write_close()`).
  3. Prepared statement: `SELECT id, api_order_id, service_id, service_name, link, quantity, charge, status, remains, start_count, created_at FROM orders WHERE user_id = ? ORDER BY created_at DESC LIMIT ?` (default limit: 50).
  4. gzip compression enabled.
- **Response**: `{ "orders": [ { "id": 1, "api_order_id": 12345, ... }, ... ] }`

### 6E. `check_order_status.php` — Sync Order Statuses
- **Method**: GET
- **Logic**: Calls `syncOrderStatuses($user_id, $conn)` from `order_manager.php`.
- **Response**: `{ "success": true, "checked": 5, "updated": 2, "updates": [...] }`

### 6F. `order_manager.php` — `syncOrderStatuses()` Function
- **Purpose**: Batch-check active orders against external API.
- **Logic**:
  1. Select orders with status IN (`pending`, `processing`, `in_progress`) or empty/null, LIMIT 20.
  2. Call external API: `POST { key, action: "status", orders: "123,456,789" }` (comma-separated API order IDs).
  3. API returns: `{ "123": { "status": "Completed", "start_count": 500, "remains": 0 }, ... }`.
  4. For each order, compare old status with new:
     - If `cancelled`/`refunded` → **Full refund**: Add `charge` back to user's balance.
     - If `partial` → **Partial refund**: Calculate `refund = charge * (remains / quantity)`, add to balance.
     - Update `orders` table: `SET status = ?, start_count = ?, remains = ?, updated_at = NOW()`.
  5. Notify admin for refunds.
  6. Return `{ checked, updated, updates[] }`.

### 6G. `user_actions.php` — Refill Orders
- **Method**: POST (JSON body)
- **Input**: `{ "action": "refill", "order_id": 123 }`
- **Logic**:
  1. Auth check.
  2. Verify order belongs to user.
  3. Check if service supports refill (look up service in `cache/services.json`, check `refill` field).
  4. Call external API: `POST { key, action: "refill", order: api_order_id }`.
  5. API returns `{ "refill": refill_id }` on success.
  6. Notify admin.
- **Response**: `{ "success": true, "message": "Refill request sent! ID: 456" }`

### 6H. `deposit_handler.php` — Process Deposit
- **Method**: POST (JSON body)
- **Input**: `{ "amount": 100.00, "reference_id": "chapa-ref-123" }`
- **Logic**:
  1. Auth check.
  2. Validate amount > 0.
  3. Insert into `deposits` table with `status = 'completed'`.
  4. Update balance: `UPDATE auth SET balance = balance + {amount} WHERE tg_id = {user_id}`.
  5. Fetch new balance.
  6. Notify admin.
- **Response**: `{ "status": "success", "new_balance": 234.56 }`

### 6I. `get_deposits.php` — Deposit History
- **Method**: GET
- **Logic**: `SELECT * FROM deposits WHERE user_id = ? ORDER BY created_at DESC LIMIT 5`.
- **Response**: `[ { "id": 1, "amount": "100.00", "reference_id": "ref-123", "status": "completed", "created_at": "2024-..." }, ... ]`

### 6J. `get_alerts.php` — User Notifications
- **Method**: GET
- **Logic**: `SELECT id, message, created_at, is_read FROM user_alerts WHERE user_id = ? ORDER BY created_at DESC LIMIT 20`. Also count unread.
- **Response**: `{ "alerts": [...], "unread_count": 3 }`

### 6K. `mark_alerts_read.php` — Mark Alerts Read
- **Method**: GET
- **Logic**: `UPDATE user_alerts SET is_read = 1 WHERE user_id = ? AND is_read = 0`.
- **Response**: `{ "success": true }`

### 6L. `chat_api.php` — Chat Messages
- **Method**: POST/GET (JSON body for POST)
- **Actions**:
  - `POST { "action": "send", "message": "Hello" }`:
    1. Rate limit check.
    2. Save to user's JSON file (`chat_data/chat_{user_id}.json`).
    3. Also insert into `chat_messages` DB table.
    4. Notify admin via bot.
    5. Response: `{ "success": true }`.
  - `POST { "action": "fetch" }` or GET:
    1. Read from user's JSON file.
    2. Response: `{ "success": true, "messages": [...] }`.

### 6M. `chat_stream.php` — Real-time Chat SSE
- **Type**: Server-Sent Events (SSE) endpoint.
- **Logic**:
  1. Auth check, release session lock.
  2. Send initial messages from user's chat JSON file.
  3. Loop (max 120 seconds, sleep 2s per iteration):
     - Check `filemtime()` of chat JSON file.
     - If modified since last check → send new messages.
     - Send heartbeat otherwise.
  4. Auto-reconnect on client side.

### 6N. `realtime_stream.php` — Unified Real-time SSE
- **Type**: Server-Sent Events (SSE) endpoint — THE MAIN REAL-TIME SYSTEM.
- **Purpose**: Single stream for orders, alerts, balance, and maintenance updates.
- **Logic**:
  1. Auth check, release session lock.
  2. Load last known state from `temp/paxyo_state_{user_id}.json`.
  3. Loop (max 30 seconds, sleep 2s per iteration):
     - Compute current state:
       - `orders_hash`: MD5 of concatenated active order IDs+statuses+remains.
       - `alerts_hash`: MD5 of concatenated alert IDs+read status.
       - `balance`: Current balance from `auth` table.
       - `maintenance_mode`: From `settings` table.
     - Compare with last state.
     - If any hash/value changed → send `{ "type": "update", "changes": ["orders", "balance", ...], "data": { full data } }`.
     - If nothing changed → send `{ "type": "heartbeat" }`.
     - Check `temp/paxyo_cron_active.flag` to determine if cron is active (controls idle heartbeat frequency).
  4. Save final state to file.
- **Client reconnection**: On error, client waits 3 seconds then reconnects.

### 6O. `heartbeat.php` — Online Status
- **Method**: GET
- **Logic**: Updates `auth.last_seen = NOW()` for the current user.
- **Called**: Every 30 seconds from frontend JS.
- **Response**: `{"ok":1}` or `{"ok":0}`

### 6P. `webhook_handler.php` — External Webhook
- **Method**: POST (from SMM provider)
- **Purpose**: Receives push notifications about order status changes.
- **Logic**:
  1. Parse incoming data (order ID, new status, remains, start_count).
  2. Find local order by `api_order_id`.
  3. Update `orders` table.
  4. Handle refunds for cancelled/partial orders.
  5. Notify real-time stream (via state file change which SSE picks up).

### 6Q. `cron_check_orders.php` — Cron Job
- **Purpose**: Periodically syncs order statuses with external API.
- **Logic**:
  1. Check if `temp/paxyo_cron_active.flag` exists — if not, exit immediately (no active orders).
  2. Query for users with active orders.
  3. For each user, call `syncOrderStatuses()`.
  4. If no more active orders found, delete the flag file.
- **Recommended**: Run every 1-2 minutes via system cron.

---

## 7. ADMIN NOTIFICATION SYSTEM

### `utils_bot.php` — `notify_bot_admin($data)`
- Sends a POST request with JSON body to `BOT_API_URL` (defined in `config_telegram.php`).
- `BOT_API_URL` points to a separate Node.js bot backend (e.g., `https://your-bot.onrender.com/api/sendToJohn`).
- **Notification types sent** (via `$data['type']`):
  - `newuser` — New user registered. Includes `uid`, `uuid` (name).
  - `order` — New order placed. Includes `uid`, `order` (ID), `service`, `amount`.
  - `deposit` — Deposit completed. Includes `uid`, `amount`, `uuid` (reference).
  - `refund` — Full refund applied. Includes `uid`, `order`, `amount`.
  - `partial` — Partial refund. Includes `uid`, `order`, `amount`, `uuid` (remains).
  - `chat` — New chat message. Includes `uid`, `uuid` (message preview).
  - `error` — Order error. Includes `uid`, `service`, `error`.
  - `refill` — Refill requested. Includes `uid`, `order`, `uuid` (refill ID), `service`.

---

## 8. FRONTEND — DETAILED IMPLEMENTATION

The frontend is a single PHP/HTML file (`smm.php`) that includes inline CSS and inline JavaScript. It operates as an **SPA** (Single Page Application) with views toggled by a bottom navigation bar.

### 8A. Critical Headers (set in PHP before any HTML)
```php
header("Access-Control-Allow-Origin: *");
header("Content-Security-Policy: frame-ancestors *");   // Allow Telegram to iframe the app
header("X-Frame-Options: ALLOWALL");
header("Cache-Control: no-store, no-cache, must-revalidate, max-age=0");
```

### 8B. Telegram Mini App Scroll Fix (CRITICAL)
The Telegram Mini App SDK intercepts swipe-down gestures to close/collapse the app. To prevent this:
1. **Lock `html` and `body`**: `overflow: hidden; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; overscroll-behavior: none;`
2. **Use a scroll wrapper**: All content inside `<div class="tg-scroll-wrapper">` which has `position: fixed; inset: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; overscroll-behavior-y: contain;`
3. **Prevent scrollTop === 0**: On `touchstart`, if `scrollTop === 0`, nudge it to `1px`. This prevents Telegram from intercepting the swipe as a close gesture.
4. **Disable vertical swipes**: Call `tg.disableVerticalSwipes()` and set `tg.isVerticalSwipesEnabled = false` on init.

### 8C. Telegram SDK Initialization (Inline Script, runs before DOM)
```javascript
(function() {
    if (window.Telegram && window.Telegram.WebApp) {
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        if (tg.disableVerticalSwipes) tg.disableVerticalSwipes();
        try { tg.isVerticalSwipesEnabled = false; } catch(e) {}
        // Apply Telegram theme colors to CSS variables
        if (tg.themeParams) {
            const root = document.documentElement;
            root.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#0a0a0f');
            root.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#ffffff');
            root.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#6c5ce7');
            root.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#1a1a24');
        }
    }
})();
```

### 8D. JavaScript Application Object (`SMM`)
The entire frontend logic lives in a single global object `window.SMM` with these key properties and methods:

#### State Properties:
```javascript
SMM = {
    isTelegramApp: Boolean,       // Detect if running inside Telegram
    services: [],                  // All loaded services
    categories: [],                // Unique category names
    recommendedServices: [],       // Array of recommended service IDs
    hiddenServices: new Set([...]),// Service IDs to hide
    orders: [],                    // User's order history
    alerts: [],                    // User's notifications
    selectedPlatform: null,        // Currently selected social platform
    selectedCategory: null,        // Currently selected category
    selectedService: null,         // Currently selected service object
    userId: Number,                // User's auth ID
    userName: String,              // Display name
    userPhoto: String,             // Profile photo URL
    userBalance: Number,           // Current balance in ETB
    userCanOrder: Boolean,         // Whether ordering is allowed (maintenance check)
    rateMultiplier: Number,        // USD-to-ETB multiplier (from PHP settings)
    discountPercent: Number,       // Active holiday discount (from PHP)
    holidayName: String,           // Name of active holiday
    hasVisited: Boolean,           // First-visit guide tracking (localStorage)
    eventSource: EventSource,      // Main SSE connection
    chatEventSource: EventSource,  // Chat SSE connection
    chatInitialized: Boolean,      // Chat init flag
}
```

#### Initialization Flow (`SMM.init()`):
1. Set up scroll wrapper touchstart listener (scrollTop = 1 fix).
2. Safety timeout: force-hide loading overlay after 2.5s.
3. If Telegram app → call `authenticateTelegram()` (POST to `telegram_auth.php` with `initData`). Race with 1.5s timeout.
4. Hide loading overlay.
5. `cacheElements()` — cache all DOM element references.
6. `bindEvents()` — set up all click/input event listeners.
7. `loadServices()` — fetch services from `get_service.php`.
8. `initDeposit()` — set up deposit form handlers.
9. `checkDepositReturn()` — check URL for `?deposit_complete=1`.
10. `setupTelegramBackButton()` — handle Telegram's hardware back button.
11. `startHeartbeat()` — ping `heartbeat.php` every 30 seconds.
12. `initRealtimeUpdates()` — connect to `realtime_stream.php` SSE.
13. `fetchAlerts()` — initial alerts state.

#### Key Methods:

**`loadServices()`**:
1. Fetch `get_service.php` and `get_recommended.php` in parallel.
2. Filter out hidden services.
3. Map each service to `{ id, category, name, type, rate, min, max, averageTime, refill, cancel }`.
4. Extract unique categories.
5. Background cache refresh: `fetch('get_service.php?refresh=1')` after 100ms.

**`selectPlatform(platform)`**:
1. Set `selectedPlatform`.
2. Update social grid button active states.
3. Update link input placeholder based on platform (e.g., "https://instagram.com/p/...").
4. Reset category/service selections.
5. If platform is "top" → auto-select "Top Services" category and open service modal.
6. Pre-render category list for instant modal opening.

**`getPlatformCategories()`**:
- Filters categories by platform keywords (e.g., "Instagram" keyword for instagram platform).
- "other" platform shows categories NOT matching any major platform.
- "top" platform returns virtual `['Top Services']` category.

**`selectCategory(category)`**:
1. Set `selectedCategory`.
2. Update UI text.
3. Update link placeholder based on category context (e.g., "follower" categories → "Profile URL").
4. Pre-render service list.

**`selectService(service)`**:
1. Set `selectedService`.
2. Display service info: name, min, max, average time, rate (with discount strikethrough if applicable).
3. Show/hide form fields based on `service.type`:
   - `Default` → Link + Quantity fields.
   - `Custom Comments` / `Custom Comments Package` / `Mentions with Hashtags` → Link + Comments textarea (quantity auto-calculated from line count).
   - `Package` → Link only (quantity fixed to min).
   - `Poll` → Link + Quantity + Answer Number field.
4. Calculate charge.
5. Scroll to order form (smooth scroll for first-time users).

**`calculateCharge()`**:
```
charge = (quantity / 1000) * selectedService.rate * rateMultiplier
if discountPercent > 0:
    charge = charge * (1 - discountPercent / 100)
```
Display: Original price with strikethrough + discounted price + "-X% OFF" badge (if discount active).

**`placeOrder()`**:
1. Validation: platform, category, service must be selected. Link required. Quantity must be numeric, multiple of 10, within min/max range. Balance must be sufficient.
2. Maintenance mode check.
3. Build payload: `{ service, link, quantity, comments?, answer_number?, username? }`.
4. POST to `process_order.php`.
5. On success: show toast, trigger celebration animation (confetti + haptic), update balance, reset form.
6. Show one-time "check History tab" guide (localStorage).

**`switchTab(tab)`**:
- `tab` = 'order' | 'history' | 'deposit' | 'refer'
- Hide all views, show selected view.
- Tab-specific actions:
  - `history` → `fetchOrders()`
  - `deposit` → update balance display + `loadDepositHistory()`
  - `refer` → `initChat()` (initializes chat on first visit to More tab)

**`fetchOrders(force, skipCheck)`**:
1. If not skipping check → fire `check_order_status.php` in background (syncs statuses).
2. Fetch `get_orders.php`.
3. Call `renderHistory()`.

**`renderHistory(filter)`**:
- Normalize statuses (`in_progress` → `processing`, `canceled` → `cancelled`, etc.).
- Filter by status chip (all/pending/processing/completed/cancelled).
- Filter by search input text (matches service name, ID, link).
- Render HTML table with columns: Order ID, Service/Link, Qty, Start, Remains, Charge, Date, Actions.
- **Action buttons**: Show "Refill" button if service supports it AND order is completed AND >24 hours since creation. Otherwise show disabled refill with countdown.

**`initRealtimeUpdates()`**:
- Connect to `realtime_stream.php` via `EventSource`.
- On `message` event with `type: "update"`:
  - If `changes` includes `orders` → `handleOrdersUpdate()` — detects status changes, shows toasts for completed/cancelled/partial.
  - If `changes` includes `alerts` → update notification dot, refresh alert modal if open.
  - If `changes` includes `balance` → animate balance update with pulse CSS.
  - If `changes` includes `maintenance` → reload page if user's order permission changed.
- On error → close and reconnect after 3 seconds.

**Deposit/Chapa Integration (`startChapaPayment(amount)`)**:
1. Check `ChapaCheckout` SDK is loaded.
2. Create `ChapaCheckout` instance with:
   - `publicKey`: Chapa public key.
   - `amount`, `currency: 'ETB'`.
   - `tx_ref`: `'paxyo-' + userId + '-' + Date.now()`.
   - `email`: `'user-' + userId + '@paxyo.com'` (generated).
   - `onSuccessfulPayment(result, refId)` → call `verifyDeposit(amount, refId)`.
   - `onPaymentFailure(error)` → suppress phone/validation false positives from Chapa SDK, show real errors.
   - `onClose()` → reset UI.
3. Call `chapa.initialize()` to render inline form in `#chapa-inline-form`.
4. **Phone number validation**: After Chapa renders, find the phone input and add custom validation:
   - Detect selected payment method (M-Pesa vs Telebirr).
   - M-Pesa numbers start with `07`, Telebirr numbers start with `09`.
   - Cross-validate: show error if M-Pesa number used with Telebirr method and vice versa.
   - Ethiopian phone numbers: 9 or 10 digits.
   - Disable/enable Chapa's submit button based on validation.

**`verifyDeposit(amount, refId)`**:
- POST to `deposit_handler.php` with `{ amount, reference_id }`.
- On success → update balance, reset form, load deposit history, show one-time guide.

**Chat System**:
- `initChat()`: Set up form submit handler. Initialize `chat_stream.php` SSE.
- `sendChatMessage(msg)`: Optimistic UI update (show message immediately). POST to `chat_api.php`. Fall back on error.
- `renderChatMessages(messages)`: Render bubbles (user = accent color right-aligned, admin = gray left-aligned). Auto-scroll to bottom.
- `initChatStream()`: SSE connection to `chat_stream.php`. On `messages` event → re-render chat. Auto-reconnect on error.

**Theme Toggle** (in More/Refer tab):
- Toggle `light-mode` class on `body`.
- Persist in `localStorage`.

**Telegram Back Button**:
- On back press: close any open modal → navigate to Order tab → close app.
- Show back button when modal opens or non-order tab is active.

**Haptic Feedback**:
- Uses `window.Telegram.WebApp.HapticFeedback.impactOccurred('light')` on button clicks.
- Uses `window.Telegram.WebApp.HapticFeedback.selectionChanged()` on tab switches.

### 8E. Toast System
- Fixed position overlay.
- Types: `success` (green), `error` (red), `info` (blue).
- Auto-dismiss after 3 seconds.
- Icon changes based on type (checkmark for success, exclamation for error).

### 8F. Loading Overlay
- Full-screen semi-transparent overlay with spinner.
- Toggled via `SMM.showLoading(true/false)`.

### 8G. Success Celebration
- Confetti-like CSS animation on successful order placement.
- Haptic vibration pattern `[50, 30, 50]` if supported.

### 8H. One-Time User Guides
- **Order History Guide**: After first order, highlight History tab with glowing animation + toast. Stored in `localStorage('order_history_guide_shown')`.
- **Deposit History Guide**: After first deposit, scroll to deposit list + highlight. Stored in `localStorage('deposit_history_guide_shown')`.

### 8I. Search System
- **Global Search Modal** (top search icon): Search across ALL services by name, ID, or category. Multi-term search (AND logic). Results show service details with highlighted matches. Click result → auto-selects platform, category, and service.
- **Modal Search** (within category/service modals): Inline search input that filters the dropdown list with real-time highlighting.
- **History Search**: Filter order history by service name, ID, link, etc.

### 8J. PHP Variables Passed to JavaScript
These are injected directly into the inline JS from PHP:
- `rateMultiplier`: From `settings.rate_multiplier`.
- `discountPercent`: From active `holidays` record.
- `holidayName`: Name of active holiday.
- `userCanOrder`: Boolean (maintenance mode + allowed IDs check).
- `userId`, `userName`, `userPhoto`, `userBalance`: From session/DB.
- `isTelegramApp`: Detected server-side.
- `hiddenServices`: From `hidden_services` table or admin config.

---

## 9. EXTERNAL CSS & JS DEPENDENCIES


<!-- Chapa Inline Checkout SDK (loaded at end of body) -->
<script src="https://js.chapa.co/v1/inline.js"></script>
```


---

## 10. KEY DESIGN PATTERNS & PERFORMANCE OPTIMIZATIONS

1. **Stale-While-Revalidate Caching**: Services are served from file cache immediately; background refresh updates cache for next request.
2. **Pre-rendering**: Category and service modal lists are pre-rendered in DOM (hidden) when a platform/category is selected, so modals open instantly.
3. **Early Session Lock Release**: `session_write_close()` is called immediately after reading session data to prevent blocking other requests.
4. **Gzip Compression**: All JSON API responses use `ob_gzhandler`.
5. **Prepared Statements**: All user-input-driven queries use MySQLi prepared statements.
6. **Optimistic UI**: Chat messages appear instantly before server confirmation.
7. **SSE State Hashing**: The real-time stream compares MD5 hashes of concatenated data to detect changes efficiently, only sending full data when something changed.
8. **Cron Flag File**: `paxyo_cron_active.flag` prevents the cron job from running when there are no active orders, saving server resources.
9. **Background Cache Refresh**: Frontend triggers `get_service.php?refresh=1` 100ms after initial load, ensuring fresh data for the next visit without blocking the current one.
10. **Quantity × 10 Rule**: All quantities must be multiples of 10 (validated both client and server side).
11. **Currency Formatting**: All ETB amounts use `toLocaleString('en-US')` with 2 decimal places, suffixed with " ETB".

---

## 11. SECURITY CONSIDERATIONS

1. **Telegram initData Validation**: HMAC-SHA256 signature verification using bot token.
2. **Google OAuth State Token**: CSRF protection via random state parameter.
3. **Session Cookie**: `SameSite=None; Secure` for cross-origin Telegram iframe compatibility.
4. **SQL Injection Prevention**: `db_escape()` + prepared statements throughout.
5. **XSS Prevention**: `escapeHtml()` function in frontend JS for user-generated content (chat messages, service names).
6. **Content Security Policy**: `frame-ancestors *` to allow Telegram embedding.
7. **Rate Limiting**: Chat messages have rate limiting on server side.
8. **Balance Race Condition Prevention**: Balance deduction uses `UPDATE auth SET balance = balance - X` (atomic SQL operation) rather than read-modify-write.

---

## 12. ADMIN PANEL (overview only — separate from user replication)

The admin panel (`admin/index.php`) provides:
- User management (view, block, adjust balance).
- Order management (view all orders, force status updates).
- Deposit analytics.
- Service visibility control (hide/show services).
- Holiday/discount management.
- Chat support (respond to user messages).
- Real-time dashboard via SSE (`admin/realtime_admin_stream.php`).
- Send notifications to users.
- Bot management.
- AI assistant integration.

---

## 13. ENVIRONMENT VARIABLES / CONFIGURATION

These values must be configured for a new deployment:

| Config | Location | Purpose |
|---|---|---|
| MySQL credentials | `db.php` | Database connection (host, user, pass, db name) |
| `TELEGRAM_BOT_TOKEN` | `config_telegram.php` | Telegram initData validation |
| `BOT_API_URL` | `config_telegram.php` | Admin notification endpoint |
| `TELEGRAM_INIT_DATA_EXPIRY` | `config_telegram.php` | Auth expiry (default: 86400s) |
| `GOOGLE_CLIENT_ID` | `config_google.php` | Google OAuth |
| `GOOGLE_CLIENT_SECRET` | `config_google.php` | Google OAuth |
| `GOOGLE_REDIRECT_URI` | `config_google.php` | Google OAuth callback URL |
| SMM API Key | Hardcoded in `get_service.php`, `process_order.php`, `order_manager.php`, `user_actions.php` | GodOfPanel API authentication |
| Chapa Public Key | Hardcoded in `smm.php` JS | Chapa inline checkout |

---

## 14. DEPLOYMENT NOTES

1. **PHP Version**: 7.4+ required. PHP 8.0+ recommended.
2. **Extensions**: `mysqli`, `curl`, `json`, `openssl`, `mbstring`.
3. **Writable Directories**: `cache/`, `chat_data/`, `temp/` must be writable by the web server.
4. **Cron Job**: Set up `cron_check_orders.php` to run every 1-2 minutes.
5. **HTTPS Required**: Session cookies use `Secure` flag. Telegram Mini Apps require HTTPS.
6. **Domain Registration**: Chapa SDK only works on registered domains (not localhost).
7. **Telegram Bot Setup**: Register bot with BotFather, set Mini App URL in bot settings.
8. **Database Setup**: Create all tables listed in Section 4 before first use. Some tables are auto-created by certain endpoints (e.g., `chat_messages`), but `auth`, `orders`, `deposits`, `settings`, `holidays`, `service_adjustments`, `user_alerts`, `admin_recommended_services` should be created manually.

---

## 15. COMPLETE USER FLOW

### Flow 1: New Telegram User
1. User opens Telegram → taps bot → opens Mini App.
2. `index.php` detects Telegram → includes `smm.php`.
3. Loading overlay shown.
4. JS sends `initData` to `telegram_auth.php` → user created in DB → session established.
5. Loading overlay hidden. App is ready.
6. User sees social grid → selects platform → selects category (modal) → selects service (modal).
7. Enters link and quantity. Charge calculated in real-time.
8. User doesn't have balance → switches to Deposit tab.
9. Enters amount → clicks Deposit → Chapa inline form appears → pays via Telebirr/M-Pesa.
10. `onSuccessfulPayment` fires → `deposit_handler.php` records deposit → balance updated.
11. User switches to New Order tab → places order → `process_order.php` → success toast + confetti.
12. Switches to History tab → sees order with "Pending" status.
13. SSE stream (`realtime_stream.php`) detects status change → toast: "Order processing..." → eventually "Order completed!".
14. Balance updates in real-time via SSE.

### Flow 2: Web User with Google Login
1. User visits `paxyo.com` → not authenticated → sees login page.
2. Clicks "Sign in with Google" → redirected to Google → consents → redirected to `google_auth.php`.
3. User created with negative ID → session established → redirected to `index.php` → `smm.php` loaded.
4. Same experience as Telegram user but without Telegram-specific features (back button, haptic feedback, etc.).

### Flow 3: Admin Chat Support
1. User navigates to More tab → scrolls to Live Support → types message.
2. Message saved to JSON file + DB → admin notified via bot.
3. Admin responds (from admin panel) → message added to JSON file.
4. Chat SSE stream detects file change → user sees admin response in real-time.

---

END OF REPLICATION PROMPT
